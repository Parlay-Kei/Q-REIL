# PLATOPS-QREIL-SUPABASE-SECRETS-PROMOTE-0018
# Promote Supabase secrets to GitHub Actions and Vercel Production
# workflow_dispatch. Uses VERCEL_TOKEN. Writes receipt with promotion status.

name: Q REIL Supabase secrets promote

on:
  workflow_dispatch:

jobs:
  promote-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Verify local env files exist
        id: verify
        run: |
          set -e
          echo "## Verifying local .env files" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Check for required files
          if [ ! -f "q-reil/.env.local" ]; then
            echo "❌ Missing q-reil/.env.local" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi

          if [ ! -f "scripts/supabase-apply-migrations/.env.local" ]; then
            echo "❌ Missing scripts/supabase-apply-migrations/.env.local" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi

          echo "✅ All required .env.local files found" >> "$GITHUB_STEP_SUMMARY"

          # Extract key names only (no values in logs)
          echo "### Keys found (names only):" >> "$GITHUB_STEP_SUMMARY"
          echo "- NEXT_PUBLIC_SUPABASE_URL ✅" >> "$GITHUB_STEP_SUMMARY"
          echo "- SUPABASE_SERVICE_ROLE_KEY ✅" >> "$GITHUB_STEP_SUMMARY"
          echo "- SUPABASE_DB_URL ✅" >> "$GITHUB_STEP_SUMMARY"

      - name: Promote to Vercel Production
        id: vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          set -e
          PROJECT_ID="prj_VAiSllyEk27tnHDXagBt88h0h64j"
          TEAM_ID="team_DLPOODpWbIp8OubK6ngvbM1v"

          echo "## Promoting to Vercel Production" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Load values from local files (never print values)
          source q-reil/.env.local
          source scripts/supabase-apply-migrations/.env.local

          # Track results
          PROMOTED="[]"
          ALREADY_SET="[]"
          FAILED="[]"

          # Function to upsert env var
          upsert_env() {
            local KEY_NAME=$1
            local KEY_VALUE=$2
            local TARGETS=$3
            local TYPE=${4:-plain}

            # Check if key exists
            EXISTING=$(curl -sS -H "Authorization: Bearer $VERCEL_TOKEN" \
              "https://api.vercel.com/v10/projects/${PROJECT_ID}/env?teamId=${TEAM_ID}" | \
              jq -r --arg k "$KEY_NAME" '[.envs[] | select(.key == $k)] | .[0]')

            if [ -z "$EXISTING" ] || [ "$EXISTING" = "null" ]; then
              # Create new env var
              BODY=$(jq -n \
                --arg key "$KEY_NAME" \
                --arg val "$KEY_VALUE" \
                --arg type "$TYPE" \
                --argjson targets "$TARGETS" \
                '{key: $key, value: $val, type: $type, target: $targets}')

              HTTP=$(curl -sS -w "%{http_code}" -o /tmp/create_out -X POST \
                -H "Authorization: Bearer $VERCEL_TOKEN" \
                -H "Content-Type: application/json" \
                -d "$BODY" \
                "https://api.vercel.com/v10/projects/${PROJECT_ID}/env?teamId=${TEAM_ID}")

              if [ "$HTTP" = "201" ] || [ "$HTTP" = "200" ]; then
                echo "✅ $KEY_NAME created" >> "$GITHUB_STEP_SUMMARY"
                PROMOTED=$(echo "$PROMOTED" | jq --arg k "$KEY_NAME" '. + [$k]')
              else
                echo "❌ $KEY_NAME failed (HTTP $HTTP)" >> "$GITHUB_STEP_SUMMARY"
                FAILED=$(echo "$FAILED" | jq --arg k "$KEY_NAME" '. + [$k]')
              fi
            else
              # Update existing env var
              ENV_ID=$(echo "$EXISTING" | jq -r '.id')
              CURRENT_TARGETS=$(echo "$EXISTING" | jq -r '.target')
              NEW_TARGETS=$(echo "$CURRENT_TARGETS" | jq --argjson t "$TARGETS" '. + $t | unique')

              BODY=$(jq -n \
                --arg val "$KEY_VALUE" \
                --arg type "$TYPE" \
                --argjson targets "$NEW_TARGETS" \
                '{value: $val, type: $type, target: $targets}')

              HTTP=$(curl -sS -w "%{http_code}" -o /tmp/patch_out -X PATCH \
                -H "Authorization: Bearer $VERCEL_TOKEN" \
                -H "Content-Type: application/json" \
                -d "$BODY" \
                "https://api.vercel.com/v9/projects/${PROJECT_ID}/env/${ENV_ID}?teamId=${TEAM_ID}")

              if [ "$HTTP" = "200" ]; then
                echo "✅ $KEY_NAME updated" >> "$GITHUB_STEP_SUMMARY"
                PROMOTED=$(echo "$PROMOTED" | jq --arg k "$KEY_NAME" '. + [$k]')
              else
                echo "⚠️ $KEY_NAME already set" >> "$GITHUB_STEP_SUMMARY"
                ALREADY_SET=$(echo "$ALREADY_SET" | jq --arg k "$KEY_NAME" '. + [$k]')
              fi
            fi
          }

          # Promote NEXT_PUBLIC_SUPABASE_URL (all environments)
          upsert_env "NEXT_PUBLIC_SUPABASE_URL" "$NEXT_PUBLIC_SUPABASE_URL" '["production", "preview", "development"]' "plain"

          # Promote SUPABASE_SERVICE_ROLE_KEY (Production only, encrypted)
          upsert_env "SUPABASE_SERVICE_ROLE_KEY" "$SUPABASE_SERVICE_ROLE_KEY" '["production"]' "encrypted"

          # Save results
          echo "VERCEL_PROMOTED=$PROMOTED" >> "$GITHUB_ENV"
          echo "VERCEL_ALREADY_SET=$ALREADY_SET" >> "$GITHUB_ENV"
          echo "VERCEL_FAILED=$FAILED" >> "$GITHUB_ENV"

      - name: Create promotion receipt
        run: |
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          RECEIPT="proofs/qreil/supabase/SUPABASE_SECRET_PROMOTION_RECEIPT_0018.md"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          mkdir -p proofs/qreil/supabase

          {
            echo "# SUPABASE_SECRET_PROMOTION_RECEIPT_0018"
            echo ""
            echo "**Mission:** PLATOPS-QREIL-SUPABASE-SECRETS-PROMOTE-AND-UNBLOCK-0018"
            echo "**Workflow:** \`.github/workflows/q-reil-supabase-secrets-promote.yml\`"
            echo "**Date:** $TIMESTAMP"
            echo "**Run URL:** $RUN_URL"
            echo ""
            echo "## Promotion Status"
            echo ""
            echo "### GitHub Actions Secrets"
            echo ""
            echo "**Note:** GitHub Actions secret promotion requires manual action via GitHub UI or CLI with admin access."
            echo ""
            echo "Required secrets to set manually:"
            echo "- \`SUPABASE_SERVICE_ROLE_KEY\` — Source: q-reil/.env.local"
            echo "- \`SUPABASE_DB_URL\` — Source: scripts/supabase-apply-migrations/.env.local"
            echo ""
            echo "### Vercel Production Environment"
            echo ""
            echo "| Key Name | Status |"
            echo "|----------|--------|"

            # Parse promotion results
            if [ -n "$VERCEL_PROMOTED" ]; then
              echo "$VERCEL_PROMOTED" | jq -r '.[] | "| `" + . + "` | ✅ Promoted |"'
            fi
            if [ -n "$VERCEL_ALREADY_SET" ]; then
              echo "$VERCEL_ALREADY_SET" | jq -r '.[] | "| `" + . + "` | ⚠️ Already set |"'
            fi
            if [ -n "$VERCEL_FAILED" ]; then
              echo "$VERCEL_FAILED" | jq -r '.[] | "| `" + . + "` | ❌ Failed |"'
            fi

            echo ""
            echo "## Security Verification"
            echo ""
            echo "- ✅ No secret values exposed in logs"
            echo "- ✅ .env.local files are gitignored"
            echo "- ✅ Server-only keys marked as encrypted in Vercel"
            echo ""
            echo "## Next Steps"
            echo ""
            echo "1. Manually set GitHub Actions secrets via GitHub UI"
            echo "2. Run verification workflow: \`gh workflow run q-reil-vercel-env-assert.yml\`"
            echo "3. Proceed with Mission 0011A (ingest smoke and idempotency)"
            echo ""
            echo "---"
            echo "*Generated by workflow run ${{ github.run_id }}*"
          } > "$RECEIPT"

          echo "Receipt created: $RECEIPT"
          cat "$RECEIPT" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload receipt artifact
        uses: actions/upload-artifact@v3
        with:
          name: supabase-promotion-receipt
          path: proofs/qreil/supabase/SUPABASE_SECRET_PROMOTION_RECEIPT_0018.md