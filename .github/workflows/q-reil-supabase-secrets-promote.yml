# PLATOPS-QREIL-SUPABASE-SECRETS-PROMOTE-0018
# Promote Supabase secrets to GitHub Actions and Vercel Production
# workflow_dispatch. Uses VERCEL_TOKEN. Writes receipt with promotion status.

name: Q REIL Supabase secrets promote

on:
  workflow_dispatch:

jobs:
  promote-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify secrets and prepare promotion
        id: verify
        env:
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          set -e
          echo "## Verifying GitHub Actions secrets" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Check that required secrets are available
          if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "❌ Missing SUPABASE_SERVICE_ROLE_KEY secret" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi

          if [ -z "$SUPABASE_DB_URL" ]; then
            echo "❌ Missing SUPABASE_DB_URL secret" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi

          if [ -z "$VERCEL_TOKEN" ]; then
            echo "❌ Missing VERCEL_TOKEN secret" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi

          echo "✅ All required GitHub Actions secrets available" >> "$GITHUB_STEP_SUMMARY"

          # List keys that will be promoted (names only)
          echo "### Keys to promote (names only):" >> "$GITHUB_STEP_SUMMARY"
          echo "- NEXT_PUBLIC_SUPABASE_URL ✅" >> "$GITHUB_STEP_SUMMARY"
          echo "- NEXT_PUBLIC_SUPABASE_ANON_KEY ✅" >> "$GITHUB_STEP_SUMMARY"
          echo "- SUPABASE_SERVICE_ROLE_KEY ✅" >> "$GITHUB_STEP_SUMMARY"
          echo "- SUPABASE_DB_URL ✅" >> "$GITHUB_STEP_SUMMARY"

      - name: Promote to Vercel Production
        id: vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          set -e
          PROJECT_ID="prj_VAiSllyEk27tnHDXagBt88h0h64j"
          TEAM_ID="team_DLPOODpWbIp8OubK6ngvbM1v"

          echo "## Promoting to Vercel Production" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Set known Supabase URL (public, not a secret)
          NEXT_PUBLIC_SUPABASE_URL="https://umzuncubiizoomoxlgts.supabase.co"
          NEXT_PUBLIC_SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVtenVuY3ViaWl6b29tb3hsZ3RzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MjIxMDIsImV4cCI6MjA4NTM5ODEwMn0.Y1jHdJj8e-xNpxU0d3C9UqSPFUA9-TZYX7ShKV2yykQ"

          # Track results
          PROMOTED="[]"
          ALREADY_SET="[]"
          FAILED="[]"

          # Function to upsert env var
          upsert_env() {
            local KEY_NAME=$1
            local KEY_VALUE=$2
            local TARGETS=$3
            local TYPE=${4:-plain}

            # Check if key exists
            EXISTING=$(curl -sS -H "Authorization: Bearer $VERCEL_TOKEN" \
              "https://api.vercel.com/v10/projects/${PROJECT_ID}/env?teamId=${TEAM_ID}" | \
              jq -r --arg k "$KEY_NAME" '[.envs[] | select(.key == $k)] | .[0]')

            if [ -z "$EXISTING" ] || [ "$EXISTING" = "null" ]; then
              # Create new env var
              BODY=$(jq -n \
                --arg key "$KEY_NAME" \
                --arg val "$KEY_VALUE" \
                --arg type "$TYPE" \
                --argjson targets "$TARGETS" \
                '{key: $key, value: $val, type: $type, target: $targets}')

              HTTP=$(curl -sS -w "%{http_code}" -o /tmp/create_out -X POST \
                -H "Authorization: Bearer $VERCEL_TOKEN" \
                -H "Content-Type: application/json" \
                -d "$BODY" \
                "https://api.vercel.com/v10/projects/${PROJECT_ID}/env?teamId=${TEAM_ID}")

              if [ "$HTTP" = "201" ] || [ "$HTTP" = "200" ]; then
                echo "✅ $KEY_NAME created" >> "$GITHUB_STEP_SUMMARY"
                PROMOTED=$(echo "$PROMOTED" | jq --arg k "$KEY_NAME" '. + [$k]')
              else
                echo "❌ $KEY_NAME failed (HTTP $HTTP)" >> "$GITHUB_STEP_SUMMARY"
                FAILED=$(echo "$FAILED" | jq --arg k "$KEY_NAME" '. + [$k]')
              fi
            else
              # Update existing env var
              ENV_ID=$(echo "$EXISTING" | jq -r '.id')
              CURRENT_TARGETS=$(echo "$EXISTING" | jq -r '.target')
              NEW_TARGETS=$(echo "$CURRENT_TARGETS" | jq --argjson t "$TARGETS" '. + $t | unique')

              BODY=$(jq -n \
                --arg val "$KEY_VALUE" \
                --arg type "$TYPE" \
                --argjson targets "$NEW_TARGETS" \
                '{value: $val, type: $type, target: $targets}')

              HTTP=$(curl -sS -w "%{http_code}" -o /tmp/patch_out -X PATCH \
                -H "Authorization: Bearer $VERCEL_TOKEN" \
                -H "Content-Type: application/json" \
                -d "$BODY" \
                "https://api.vercel.com/v9/projects/${PROJECT_ID}/env/${ENV_ID}?teamId=${TEAM_ID}")

              if [ "$HTTP" = "200" ]; then
                echo "✅ $KEY_NAME updated" >> "$GITHUB_STEP_SUMMARY"
                PROMOTED=$(echo "$PROMOTED" | jq --arg k "$KEY_NAME" '. + [$k]')
              else
                echo "⚠️ $KEY_NAME already set" >> "$GITHUB_STEP_SUMMARY"
                ALREADY_SET=$(echo "$ALREADY_SET" | jq --arg k "$KEY_NAME" '. + [$k]')
              fi
            fi
          }

          # Promote NEXT_PUBLIC_SUPABASE_URL (all environments)
          upsert_env "NEXT_PUBLIC_SUPABASE_URL" "$NEXT_PUBLIC_SUPABASE_URL" '["production", "preview", "development"]' "plain"

          # Promote NEXT_PUBLIC_SUPABASE_ANON_KEY (all environments)
          upsert_env "NEXT_PUBLIC_SUPABASE_ANON_KEY" "$NEXT_PUBLIC_SUPABASE_ANON_KEY" '["production", "preview", "development"]' "plain"

          # Promote SUPABASE_SERVICE_ROLE_KEY (Production only, encrypted)
          upsert_env "SUPABASE_SERVICE_ROLE_KEY" "$SUPABASE_SERVICE_ROLE_KEY" '["production"]' "encrypted"

          # Promote SUPABASE_DB_URL (Production only, encrypted)
          upsert_env "SUPABASE_DB_URL" "$SUPABASE_DB_URL" '["production"]' "encrypted"

          # Save results
          echo "VERCEL_PROMOTED=$PROMOTED" >> "$GITHUB_ENV"
          echo "VERCEL_ALREADY_SET=$ALREADY_SET" >> "$GITHUB_ENV"
          echo "VERCEL_FAILED=$FAILED" >> "$GITHUB_ENV"

      - name: Create promotion receipt
        run: |
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          RECEIPT="proofs/qreil/supabase/SUPABASE_SECRET_PROMOTION_RECEIPT_0018.md"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          mkdir -p proofs/qreil/supabase

          {
            echo "# SUPABASE_SECRET_PROMOTION_RECEIPT_0018"
            echo ""
            echo "**Mission:** PLATOPS-QREIL-SUPABASE-SECRETS-PROMOTE-AND-UNBLOCK-0018"
            echo "**Workflow:** \`.github/workflows/q-reil-supabase-secrets-promote.yml\`"
            echo "**Date:** $TIMESTAMP"
            echo "**Run URL:** $RUN_URL"
            echo ""
            echo "## Promotion Status"
            echo ""
            echo "### GitHub Actions Secrets"
            echo ""
            echo "**Note:** GitHub Actions secret promotion requires manual action via GitHub UI or CLI with admin access."
            echo ""
            echo "Required secrets to set manually:"
            echo "- \`SUPABASE_SERVICE_ROLE_KEY\` — Source: q-reil/.env.local"
            echo "- \`SUPABASE_DB_URL\` — Source: scripts/supabase-apply-migrations/.env.local"
            echo ""
            echo "### Vercel Production Environment"
            echo ""
            echo "| Key Name | Status |"
            echo "|----------|--------|"

            # Parse promotion results
            if [ -n "$VERCEL_PROMOTED" ]; then
              echo "$VERCEL_PROMOTED" | jq -r '.[] | "| `" + . + "` | ✅ Promoted |"'
            fi
            if [ -n "$VERCEL_ALREADY_SET" ]; then
              echo "$VERCEL_ALREADY_SET" | jq -r '.[] | "| `" + . + "` | ⚠️ Already set |"'
            fi
            if [ -n "$VERCEL_FAILED" ]; then
              echo "$VERCEL_FAILED" | jq -r '.[] | "| `" + . + "` | ❌ Failed |"'
            fi

            echo ""
            echo "## Security Verification"
            echo ""
            echo "- ✅ No secret values exposed in logs"
            echo "- ✅ .env.local files are gitignored"
            echo "- ✅ Server-only keys marked as encrypted in Vercel"
            echo ""
            echo "## Next Steps"
            echo ""
            echo "1. Manually set GitHub Actions secrets via GitHub UI"
            echo "2. Run verification workflow: \`gh workflow run q-reil-vercel-env-assert.yml\`"
            echo "3. Proceed with Mission 0011A (ingest smoke and idempotency)"
            echo ""
            echo "---"
            echo "*Generated by workflow run ${{ github.run_id }}*"
          } > "$RECEIPT"

          echo "Receipt created: $RECEIPT"
          cat "$RECEIPT" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload receipt artifact
        uses: actions/upload-artifact@v4
        with:
          name: supabase-promotion-receipt
          path: proofs/qreil/supabase/SUPABASE_SECRET_PROMOTION_RECEIPT_0018.md