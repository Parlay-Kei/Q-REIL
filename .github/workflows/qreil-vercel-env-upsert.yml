# PLATOPS-QREIL-VERCEL-PROD-ENV-SET-0014: Upsert Gmail OAuth credentials to Vercel Production
# workflow_dispatch. Uses VERCEL_TOKEN. Writes receipt with execution proof.

name: Q REIL Vercel Prod Env Upsert

on:
  workflow_dispatch:

jobs:
  upsert-env:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read client secret from GitHub secret
        id: read-secret
        env:
          CLIENT_SECRET: ${{ secrets.GMAIL_CLIENT_SECRET }}
        run: |
          echo "CLIENT_SECRET_LENGTH=${#CLIENT_SECRET}" >> $GITHUB_OUTPUT
          echo "::add-mask::$CLIENT_SECRET"

      - name: Upsert GMAIL_CLIENT_ID
        id: upsert-client-id
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          set -e
          PROJECT_ID="prj_VAiSllyEk27tnHDXagBt88h0h64j"
          TEAM_ID="team_DLPOODpWbIp8OubK6ngvbM1v"
          CLIENT_ID="965296887107-egl0puf1d2hbd8jsu0rbemtlg8ohqde5.apps.googleusercontent.com"
          
          # Check if key exists
          RESP=$(curl -sS -H "Authorization: Bearer $VERCEL_TOKEN" \
            "https://api.vercel.com/v10/projects/${PROJECT_ID}/env?teamId=${TEAM_ID}")
          EXISTING=$(echo "$RESP" | jq -r --arg k "GMAIL_CLIENT_ID" '[.envs[] | select(.key == $k)] | .[0]')
          
          if [ "$EXISTING" != "null" ] && [ -n "$EXISTING" ]; then
            ENV_ID=$(echo "$EXISTING" | jq -r '.id')
            # Update existing
            HTTP=$(curl -sS -w "%{http_code}" -o /tmp/update_out -X PATCH \
              -H "Authorization: Bearer $VERCEL_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"key\":\"GMAIL_CLIENT_ID\",\"value\":\"${CLIENT_ID}\",\"target\":[\"production\"],\"type\":\"encrypted\"}" \
              "https://api.vercel.com/v9/projects/${PROJECT_ID}/env/${ENV_ID}?teamId=${TEAM_ID}")
            if [ "$HTTP" = "200" ]; then
              echo "ACTION=updated" >> $GITHUB_OUTPUT
              echo "ENV_ID=${ENV_ID}" >> $GITHUB_OUTPUT
            else
              echo "ACTION=failed" >> $GITHUB_OUTPUT
              echo "HTTP_CODE=${HTTP}" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            # Create new
            HTTP=$(curl -sS -w "%{http_code}" -o /tmp/create_out -X POST \
              -H "Authorization: Bearer $VERCEL_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"key\":\"GMAIL_CLIENT_ID\",\"value\":\"${CLIENT_ID}\",\"target\":[\"production\"],\"type\":\"encrypted\"}" \
              "https://api.vercel.com/v10/projects/${PROJECT_ID}/env?teamId=${TEAM_ID}")
            if [ "$HTTP" = "200" ] || [ "$HTTP" = "201" ]; then
              ENV_ID=$(cat /tmp/create_out | jq -r '.uid // .id')
              echo "ACTION=created" >> $GITHUB_OUTPUT
              echo "ENV_ID=${ENV_ID}" >> $GITHUB_OUTPUT
            else
              echo "ACTION=failed" >> $GITHUB_OUTPUT
              echo "HTTP_CODE=${HTTP}" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

      - name: Upsert GMAIL_CLIENT_SECRET
        id: upsert-client-secret
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          CLIENT_SECRET: ${{ secrets.GMAIL_CLIENT_SECRET }}
        run: |
          set -e
          PROJECT_ID="prj_VAiSllyEk27tnHDXagBt88h0h64j"
          TEAM_ID="team_DLPOODpWbIp8OubK6ngvbM1v"
          echo "::add-mask::$CLIENT_SECRET"
          
          # Check if key exists
          RESP=$(curl -sS -H "Authorization: Bearer $VERCEL_TOKEN" \
            "https://api.vercel.com/v10/projects/${PROJECT_ID}/env?teamId=${TEAM_ID}")
          EXISTING=$(echo "$RESP" | jq -r --arg k "GMAIL_CLIENT_SECRET" '[.envs[] | select(.key == $k)] | .[0]')
          
          if [ "$EXISTING" != "null" ] && [ -n "$EXISTING" ]; then
            ENV_ID=$(echo "$EXISTING" | jq -r '.id')
            # Update existing
            HTTP=$(curl -sS -w "%{http_code}" -o /tmp/update_out -X PATCH \
              -H "Authorization: Bearer $VERCEL_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"key\":\"GMAIL_CLIENT_SECRET\",\"value\":\"${CLIENT_SECRET}\",\"target\":[\"production\"],\"type\":\"encrypted\"}" \
              "https://api.vercel.com/v9/projects/${PROJECT_ID}/env/${ENV_ID}?teamId=${TEAM_ID}")
            if [ "$HTTP" = "200" ]; then
              echo "ACTION=updated" >> $GITHUB_OUTPUT
              echo "ENV_ID=${ENV_ID}" >> $GITHUB_OUTPUT
            else
              echo "ACTION=failed" >> $GITHUB_OUTPUT
              echo "HTTP_CODE=${HTTP}" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            # Create new
            HTTP=$(curl -sS -w "%{http_code}" -o /tmp/create_out -X POST \
              -H "Authorization: Bearer $VERCEL_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"key\":\"GMAIL_CLIENT_SECRET\",\"value\":\"${CLIENT_SECRET}\",\"target\":[\"production\"],\"type\":\"encrypted\"}" \
              "https://api.vercel.com/v10/projects/${PROJECT_ID}/env?teamId=${TEAM_ID}")
            if [ "$HTTP" = "200" ] || [ "$HTTP" = "201" ]; then
              ENV_ID=$(cat /tmp/create_out | jq -r '.uid // .id')
              echo "ACTION=created" >> $GITHUB_OUTPUT
              echo "ENV_ID=${ENV_ID}" >> $GITHUB_OUTPUT
            else
              echo "ACTION=failed" >> $GITHUB_OUTPUT
              echo "HTTP_CODE=${HTTP}" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

      - name: Verify keys exist
        id: verify-keys
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          set -e
          PROJECT_ID="prj_VAiSllyEk27tnHDXagBt88h0h64j"
          TEAM_ID="team_DLPOODpWbIp8OubK6ngvbM1v"
          
          RESP=$(curl -sS -H "Authorization: Bearer $VERCEL_TOKEN" \
            "https://api.vercel.com/v10/projects/${PROJECT_ID}/env?teamId=${TEAM_ID}")
          
          CLIENT_ID_EXISTS=$(echo "$RESP" | jq -r '[.envs[] | select(.key == "GMAIL_CLIENT_ID") | select(.target[]? == "production")] | length')
          CLIENT_SECRET_EXISTS=$(echo "$RESP" | jq -r '[.envs[] | select(.key == "GMAIL_CLIENT_SECRET") | select(.target[]? == "production")] | length')
          
          echo "CLIENT_ID_EXISTS=${CLIENT_ID_EXISTS}" >> $GITHUB_OUTPUT
          echo "CLIENT_SECRET_EXISTS=${CLIENT_SECRET_EXISTS}" >> $GITHUB_OUTPUT
          
          if [ "$CLIENT_ID_EXISTS" = "0" ] || [ "$CLIENT_SECRET_EXISTS" = "0" ]; then
            echo "Verification failed: Keys not found in Production"
            exit 1
          fi

      - name: Write receipt
        env:
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          CLIENT_ID_ACTION: ${{ steps.upsert-client-id.outputs.ACTION }}
          CLIENT_SECRET_ACTION: ${{ steps.upsert-client-secret.outputs.ACTION }}
          CLIENT_ID_EXISTS: ${{ steps.verify-keys.outputs.CLIENT_ID_EXISTS }}
          CLIENT_SECRET_EXISTS: ${{ steps.verify-keys.outputs.CLIENT_SECRET_EXISTS }}
        run: |
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          RECEIPT="proofs/qreil/oauth/VERCEL_PROD_ENV_RECEIPT.md"
          mkdir -p proofs/qreil/oauth
          
          {
            echo "# Vercel Production Env Receipt — PLATOPS-QREIL-VERCEL-PROD-ENV-SET-0014"
            echo ""
            echo "**Mission:** PLATOPS-QREIL-VERCEL-PROD-ENV-SET-0014"
            echo "**Owner:** PLATOPS → QAG"
            echo "**Date:** $TIMESTAMP"
            echo "**Scope:** Set canonical Gmail client credentials in Vercel Production for Q REIL."
            echo ""
            echo "---"
            echo ""
            echo "## 1. Execution Summary"
            echo ""
            echo "| Item | Value |"
            echo "|------|-------|"
            echo "| **Workflow** | Q REIL Vercel Prod Env Upsert |"
            echo "| **Run URL** | $RUN_URL |"
            echo "| **Execution Time** | $TIMESTAMP |"
            echo ""
            echo "---"
            echo ""
            echo "## 2. Environment Variables Set"
            echo ""
            echo "| Key Name | Action | Status |"
            echo "|----------|--------|--------|"
            echo "| **GMAIL_CLIENT_ID** | $CLIENT_ID_ACTION | ✅ Success |"
            echo "| **GMAIL_CLIENT_SECRET** | $CLIENT_SECRET_ACTION | ✅ Success |"
            echo ""
            echo "---"
            echo ""
            echo "## 3. Verification"
            echo ""
            echo "| Key Name | Exists in Production |"
            echo "|----------|---------------------|"
            echo "| **GMAIL_CLIENT_ID** | ✅ Yes ($CLIENT_ID_EXISTS entry) |"
            echo "| **GMAIL_CLIENT_SECRET** | ✅ Yes ($CLIENT_SECRET_EXISTS entry) |"
            echo ""
            echo "---"
            echo ""
            echo "## 4. QAG Acceptance Checks"
            echo ""
            echo "- [x] **Evidence shows env keys exist for Production:**"
            echo "  - ✅ GMAIL_CLIENT_ID exists in Production"
            echo "  - ✅ GMAIL_CLIENT_SECRET exists in Production"
            echo "  - Evidence: Workflow verification step"
            echo ""
            echo "- [x] **No secret values exposed:**"
            echo "  - ✅ Values masked in workflow logs"
            echo "  - ✅ Receipt shows key names only"
            echo "  - Evidence: This receipt"
            echo ""
            echo "- [x] **Verdict:** ✅ **PASS**"
            echo ""
            echo "---"
            echo ""
            echo "## 5. Receipt Status"
            echo ""
            echo "| Criterion | Status |"
            echo "|-----------|--------|"
            echo "| GMAIL_CLIENT_ID set | ✅ Completed |"
            echo "| GMAIL_CLIENT_SECRET set | ✅ Completed |"
            echo "| Keys verified | ✅ Completed |"
            echo "| QAG acceptance | ✅ PASS |"
            echo ""
            echo "**Status:** ✅ **COMPLETE** — Vercel Production environment variables set successfully."
            echo ""
            echo "---"
            echo ""
            echo "## 6. References"
            echo ""
            echo "- [OAUTH_CLIENT_CREATE_RECEIPT.md](./OAUTH_CLIENT_CREATE_RECEIPT.md) — OAuth client creation receipt"
            echo "- [GHA_VERCEL_TOKEN_VERIFY_RECEIPT.md](./GHA_VERCEL_TOKEN_VERIFY_RECEIPT.md) — GitHub Actions secret verification"
            echo "- [docs/q-suite/OAUTH_CANON.md](../../docs/q-suite/OAUTH_CANON.md) — canonical project, client, variable names"
          } > "$RECEIPT"
          
          echo "Receipt written to $RECEIPT"

      - name: Upload receipt artifact
        uses: actions/upload-artifact@v4
        with:
          name: platrops-qreil-vercel-prod-env-receipt
          path: proofs/qreil/oauth/VERCEL_PROD_ENV_RECEIPT.md
